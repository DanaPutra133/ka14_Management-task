<!DOCTYPE html>
<html lang="id" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Tugas Mahasiswa 3KA14</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', card: '#1e293b', text: '#e2e8f0' },
                        primary: { DEFAULT: '#2563eb', hover: '#1d4ed8' }
                    },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        .task-card { transition: all 0.3s ease; }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1); }
        
        .custom-checkbox { appearance: none; background-color: transparent; margin: 0; font: inherit; color: currentColor; width: 1.4em; height: 1.4em; border: 2px solid currentColor; border-radius: 0.35em; display: grid; place-content: center; cursor: pointer; transition: 0.2s; }
        .custom-checkbox::before { content: ""; width: 0.8em; height: 0.8em; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em white; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .custom-checkbox:checked { background-color: #10B981; border-color: #10B981; }
        .custom-checkbox:checked::before { transform: scale(1); }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #progressBar { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .filter-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .dark .filter-btn.active { background-color: #3b82f6; border-color: #3b82f6; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; }
        .category-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .dark .category-btn.active { background-color: #3b82f6; border-color: #3b82f6; }

        .status-btn.active[data-status="all"] { background-color: #4b5563; color: white; border-color: #4b5563; }
        .status-btn.active[data-status="completed"] { background-color: #10B981; color: white; border-color: #10B981; }
        .status-btn.active[data-status="pending"] { background-color: #EF4444; color: white; border-color: #EF4444; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-dark-bg dark:text-dark-text min-h-screen p-4 sm:p-6 lg:p-8">

    <div class="max-w-6xl mx-auto">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Dashboard Tugas
                    <span id="displayNpm" class="text-sm font-mono font-medium bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded-md hidden">
                        ...
                    </span>
                
                <p class="text-gray-500 dark:text-gray-400 text-sm">Web Mengelola tugas khusus 3ka14</p>
            </div>

            <div class="flex items-center gap-2 bg-white dark:bg-dark-card p-1.5 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                
                <button onclick="openProfileModal()" class="w-9 h-9 rounded-full border border-gray-200 dark:border-gray-600 overflow-hidden hover:ring-2 hover:ring-blue-500 transition mr-1" title="Profile Saya">
                    <img id="headerAvatar" src="./img/splash2.jpg" class="w-full h-full object-cover">
                </button>

                <div class="w-px h-5 bg-gray-300 dark:bg-gray-600 mx-1"></div>

                <span id="editorBtnPlace"></span>

                <button onclick="openClassModal()" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition text-blue-600 dark:text-blue-400" title="Progress Kelas">
                    <i class="ph ph-users-three text-xl"></i>
                </button>

                <div class="w-px h-5 bg-gray-300 dark:bg-gray-600 mx-1"></div>

                <button onclick="setLayout('list')" id="btnList" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition" title="List View"><i class="ph ph-list-dashes text-xl"></i></button>
                <button onclick="setLayout('grid')" id="btnGrid" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition" title="Grid View"><i class="ph ph-squares-four text-xl"></i></button>
                
                <div class="w-px h-5 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                
                <button onclick="toggleDarkMode()" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition text-yellow-500"><i id="themeIcon" class="ph ph-sun text-xl"></i></button>
                
                <div class="w-px h-5 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                
                <button onclick="logout()" class="flex items-center gap-2 px-3 py-1.5 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/40 rounded text-sm font-medium transition"><i class="ph ph-sign-out"></i> Keluar</button>
            </div>
        </header>

        <div class="bg-white dark:bg-dark-card rounded-xl border border-gray-200 dark:border-gray-700 p-5 mb-6 shadow-sm">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <span class="text-sm font-semibold text-gray-700 dark:text-gray-300 block">Progres Saya</span>
                    <span class="text-xs text-gray-500 dark:text-gray-400" id="progressText">Menghitung data...</span>
                </div>
                <span class="text-2xl font-bold text-primary dark:text-blue-400" id="progressPercent">0%</span>
            </div>
            <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                <div id="progressBar" class="bg-blue-600 dark:bg-blue-500 h-full rounded-full" style="width: 0%"></div>
            </div>
        </div>
        <div class="mb-6 space-y-3">
        <div class="flex items-center gap-2 overflow-x-auto pb-1 scrollbar-hide">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider mr-1">Status:</span>
                <button onclick="setStatusFilter('all')" class="status-btn active px-3 py-1 rounded-full border border-gray-200 dark:border-gray-700 text-xs font-medium bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-gray-700 transition" data-status="all">Semua</button>
                <button onclick="setStatusFilter('completed')" class="status-btn px-3 py-1 rounded-full border border-green-200 dark:border-green-800 text-xs font-medium bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 hover:bg-green-100 transition" data-status="completed">Selesai</button>
                <button onclick="setStatusFilter('pending')" class="status-btn px-3 py-1 rounded-full border border-red-200 dark:border-red-800 text-xs font-medium bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 hover:bg-red-100 transition" data-status="pending">Belum</button>
            </div>        
        </div>

        <div class="flex flex-wrap gap-2 mb-6 overflow-x-auto pb-2 scrollbar-hide">
            <button onclick="setCategoryFilter('all')" class="filter-btn active px-4 py-1.5 rounded-full border border-gray-200 dark:border-gray-700 text-sm font-medium bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-gray-700 transition whitespace-nowrap" data-filter="all">Semua</button>
            <button onclick="setCategoryFilter('kelompok')" class="filter-btn px-4 py-1.5 rounded-full border border-gray-200 dark:border-gray-700 text-sm font-medium bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-gray-700 transition whitespace-nowrap" data-filter="kelompok">Kelompok</button>
            <button onclick="setCategoryFilter('vclass')" class="filter-btn px-4 py-1.5 rounded-full border border-gray-200 dark:border-gray-700 text-sm font-medium bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-gray-700 transition whitespace-nowrap" data-filter="vclass">VClass</button>
            <button onclick="setCategoryFilter('praktikum')" class="filter-btn px-4 py-1.5 rounded-full border border-gray-200 dark:border-gray-700 text-sm font-medium bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-gray-700 transition whitespace-nowrap" data-filter="praktikum">Praktikum</button>
            <button onclick="setCategoryFilter('ilab')" class="filter-btn px-4 py-1.5 rounded-full border border-gray-200 dark:border-gray-700 text-sm font-medium bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-gray-700 transition whitespace-nowrap" data-filter="ilab">iLab</button>
            <button onclick="setCategoryFilter('mandiri')" class="filter-btn px-4 py-1.5 rounded-full border border-gray-200 dark:border-gray-700 text-sm font-medium bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-gray-700 transition whitespace-nowrap" data-filter="mandiri">Mandiri</button>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
            <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-gray-700 p-4 rounded-xl flex items-center justify-between shadow-sm">
                <div><p class="text-gray-500 dark:text-gray-400 text-xs font-medium uppercase tracking-wide">Total Tugas</p><h2 class="text-2xl font-bold text-gray-800 dark:text-white mt-1" id="totalCount">0</h2></div>
                <div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-blue-600 dark:text-blue-400"><i class="ph ph-books text-2xl"></i></div>
            </div>
            <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-gray-700 p-4 rounded-xl flex items-center justify-between shadow-sm">
                <div><p class="text-gray-500 dark:text-gray-400 text-xs font-medium uppercase tracking-wide">Selesai</p><h2 class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1" id="doneCount">0</h2></div>
                <div class="p-2 bg-green-50 dark:bg-green-900/20 rounded-lg text-green-600 dark:text-green-400"><i class="ph ph-check-circle text-2xl"></i></div>
            </div>
            <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-gray-700 p-4 rounded-xl flex items-center justify-between shadow-sm">
                <div><p class="text-gray-500 dark:text-gray-400 text-xs font-medium uppercase tracking-wide">Belum</p><h2 class="text-2xl font-bold text-red-600 dark:text-red-400 mt-1" id="pendingCount">0</h2></div>
                <div class="p-2 bg-red-50 dark:bg-red-900/20 rounded-lg text-red-600 dark:text-red-400"><i class="ph ph-clock text-2xl"></i></div>
            </div>
        </div>

        <div id="loading" class="hidden"><div class="loader"></div></div>
        <div id="taskContainer" class="grid gap-4 transition-all duration-300"></div>

    </div>

    <div id="profileModal" class="fixed inset-0 z-[1000] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 transition-opacity duration-300" onclick="closeProfileModal()">
        <div class="relative bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-md w-full mx-4 transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
            
            <div class="flex justify-between items-start mb-6 border-b border-gray-100 dark:border-gray-700 pb-4">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Profile Saya</h3>
                <button onclick="closeProfileModal()" class="text-gray-500 hover:text-red-500 transition"><i class="ph ph-x text-xl"></i></button>
            </div>

            <form id="profileForm" class="space-y-4">
                <div class="flex flex-col items-center mb-4">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('profileUpload').click()">
                        <img id="previewProfile" src="https://ui-avatars.com/api/?name=User" class="w-24 h-24 rounded-full object-cover border-4 border-white dark:border-gray-700 shadow-md group-hover:opacity-75 transition">
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                            <i class="ph ph-camera text-white text-2xl drop-shadow-md"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Klik foto untuk ganti</p>
                    
                    <input type="file" id="profileUpload" class="hidden" accept="image/*" onchange="uploadProfilePic(this)">
                    <input type="hidden" id="profileUrlInput">
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">NPM</label>
                        <input type="text" id="profNpm" disabled class="w-full bg-gray-100 dark:bg-gray-700 border-none rounded-lg p-2.5 text-sm text-gray-500 font-mono">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Nama Lengkap</label>
                        <input type="text" id="profNama" placeholder="Masukkan nama..." class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 text-sm dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Email</label>
                            <input type="email" id="profEmail" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 text-sm dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">No. Handphone</label>
                            <input type="text" id="profHp" placeholder="08xxxxx" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 text-sm dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-medium shadow-md transition mt-4">
                    Simpan Perubahan
                </button>
            </form>
        </div>
    </div>

    <div id="universalModal" class="fixed inset-0 z-[999] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 transition-opacity duration-300" onclick="closeModal()">
        <div class="relative bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[85vh] flex flex-col overflow-hidden transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2"></h3>
                <button onclick="closeModal()" class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition"><i class="ph ph-x text-lg"></i></button>
            </div>
            <div class="overflow-y-auto pr-2 custom-scrollbar">
                <img id="modalImage" src="" alt="Preview" class="hidden w-full h-auto object-contain rounded-lg shadow-sm">
                <div id="modalText" class="hidden text-gray-700 dark:text-gray-300 text-sm leading-relaxed whitespace-pre-wrap bg-gray-50 dark:bg-gray-900/50 p-4 rounded-lg border border-gray-100 dark:border-gray-700"></div>
            </div>
        </div>
    </div>

    <div id="classModal" class="fixed inset-0 z-[999] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 transition-opacity duration-300" onclick="closeClassModal()">
        <div class="relative bg-white dark:bg-gray-800 p-0 rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[85vh] flex flex-col overflow-hidden transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
            
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="ph ph-chart-bar-horizontal text-blue-500"></i> Progres Pengerjaan Kelas
                </h3>
                <button onclick="closeClassModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white transition">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>

            <div class="overflow-y-auto custom-scrollbar p-5">
                <table class="w-full text-sm text-left border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                    <thead class="bg-gray-100 dark:bg-gray-900 uppercase text-xs text-gray-600 dark:text-gray-300 font-semibold">
                        <tr>
                            <th class="px-6 py-4">Mahasiswa</th>
                            <th class="px-6 py-4">Progress Tugas</th>
                            <th class="px-6 py-4 text-right">Status</th>
                            <th class="px-6 py-4 text-center">Detail</th>
                        </tr>
                    </thead>
                    <tbody id="classProgressBody" class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
                        <tr><td colspan="4" class="text-center py-6 text-gray-500">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentLayout = localStorage.getItem('layout') || 'list';
        let isDarkMode = localStorage.getItem('theme') === 'dark';
        let activeFilter = 'all';
        let activeCategory = 'all'; 
        let activeStatus = 'all';
        let globalTasks = [];
        function setCategoryFilter(category) {
            activeCategory = category;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.dataset.category === category) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            renderTasks();
        }

        function setStatusFilter(status) {
            activeStatus = status;
            document.querySelectorAll('.status-btn').forEach(btn => {
                if(btn.dataset.status === status) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            renderTasks();
        }
        function initTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            if (isDarkMode) {
                html.classList.add('dark');
                icon.classList.replace('ph-sun', 'ph-moon');
            } else {
                html.classList.remove('dark');
                icon.classList.replace('ph-moon', 'ph-sun');
            }
        }
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            initTheme();
        }

        function setLayout(mode) {
            currentLayout = mode;
            localStorage.setItem('layout', mode);
            updateLayoutUI();
            renderTasks(); 
        }
        function updateLayoutUI() {
            const btnList = document.getElementById('btnList');
            const btnGrid = document.getElementById('btnGrid');
            const container = document.getElementById('taskContainer');
            const activeClass = ['bg-blue-100', 'text-blue-600', 'dark:bg-blue-900', 'dark:text-blue-300'];  
            btnList.classList.remove(...activeClass);
            btnGrid.classList.remove(...activeClass);
            if (currentLayout === 'list') {
                btnList.classList.add(...activeClass);
                container.className = 'flex flex-col gap-4';
            } else {
                btnGrid.classList.add(...activeClass);
                container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
            }
        }

        function setFilter(filter) {
            activeFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.dataset.filter === filter) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            renderTasks();
        }

        async function loadDashboard() {
            const loader = document.getElementById('loading');
            loader.classList.remove('hidden');
            try {
                const res = await fetch('/api/student/dashboard');
                if (res.status === 401) { window.location.href = '/login-mahasiswa'; return; }
                const tasks = await res.json();
                globalTasks = tasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
                loader.classList.add('hidden');
                checkIfEditor(); 
                updateHeaderAvatar(); 
                renderTasks(); 
                updateStats(); 
            } catch (e) {
                console.error(e);
                loader.classList.add('hidden');
            }
        }

        async function checkIfEditor() {
            try {
                const res = await fetch('/api/check-session');
                const data = await res.json();
                const container = document.getElementById('editorBtnPlace');

                if (data.user && data.user.isEditor) {
                    if(!document.getElementById('btnEditor')) {
                        const btn = document.createElement('a');
                        btn.id = 'btnEditor';
                        btn.href = '/editor-tugas.html';
                        btn.className = 'p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition text-purple-600 dark:text-purple-400 mr-2';
                        btn.title = "Mode Editor";
                        btn.innerHTML = '<i class="ph ph-pencil-simple-line text-xl"></i>';
                        container.appendChild(btn);
                    }
                }
            } catch (e) { console.error(e); }
        }
        async function openProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.firstElementChild.classList.remove('scale-95');
                modal.firstElementChild.classList.add('scale-100');
            }, 10);

            try {
                const res = await fetch('/api/student/profile');
                const user = await res.json();

                document.getElementById('profNpm').value = user.npm;
                document.getElementById('profEmail').value = user.email;
                document.getElementById('profNama').value = user.nama || '';
                document.getElementById('profHp').value = user.noHp || '';
                document.getElementById('profileUrlInput').value = user.fotoProfile || '';

                const defaultAvatar = `./img/splash2.jpg`;
                document.getElementById('previewProfile').src = user.fotoProfile || defaultAvatar;

            } catch (e) { console.error("Gagal load profile", e); }
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.add('opacity-0');
            modal.firstElementChild.classList.remove('scale-100');
            modal.firstElementChild.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function uploadProfilePic(input) {
            const file = input.files[0];
            if(!file) return;

            const imgEl = document.getElementById('previewProfile');
            imgEl.style.opacity = '0.5';

            const formData = new FormData();
            formData.append('image', file);

            try {
                const res = await fetch('/upload-proxy', {
                    method: 'POST', body: formData
                });
                const data = await res.json();

                if(data.url) {
                    document.getElementById('profileUrlInput').value = data.url;
                    imgEl.src = data.url;
                    document.getElementById('headerAvatar').src = data.url;
                } else {
                    Swal.fire('Error', 'Gagal upload foto', 'error');
                }
            } catch (e) {
                Swal.fire('Error', 'Terjadi kesalahan upload', 'error');
            } finally {
                imgEl.style.opacity = '1';
            }
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                nama: document.getElementById('profNama').value,
                email: document.getElementById('profEmail').value,
                noHp: document.getElementById('profHp').value,
                fotoProfile: document.getElementById('profileUrlInput').value
            };

            try {
                const res = await fetch('/api/student/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if(data.success) {
                    Swal.fire({ icon: 'success', title: 'Tersimpan', text: 'Data profile berhasil diperbarui', timer: 1500, showConfirmButton: false });
                    closeProfileModal();
                    updateHeaderAvatar();
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                Swal.fire('Gagal', 'Gagal menyimpan profile', 'error');
            }
        });

        async function updateHeaderAvatar() {
            try {
                const res = await fetch('/api/student/profile');
                const user = await res.json();
                const avatar = user.fotoProfile || `./img/splash2.jpg`;
                document.getElementById('headerAvatar').src = avatar;
                const npmBadge = document.getElementById('displayNpm');
                if (user.npm) {
                    npmBadge.innerText = user.npm;
                    npmBadge.classList.remove('hidden'); 
                }

            } catch(e) {
                console.error("Gagal load info header", e);
            }
        }

        function renderTasks() {
            const container = document.getElementById('taskContainer');
            container.innerHTML = '';

            const filteredTasks = globalTasks.filter(t => {
               let categoryMatch = false;
                if (activeCategory === 'all') categoryMatch = true;
                else if (activeCategory === 'kelompok' && t.kelompok) categoryMatch = true;
                else if (activeCategory === 'vclass' && t.vclass) categoryMatch = true;
                else if (activeCategory === 'praktikum' && t.praktikum) categoryMatch = true;
                else if (activeCategory === 'ilab' && t.ilab) categoryMatch = true;
                else if (activeCategory === 'mandiri' && t.Mandiri) categoryMatch = true;

                let statusMatch = false;
                if (activeStatus === 'all') statusMatch = true;
                else if (activeStatus === 'completed' && t.isCompleted) statusMatch = true;
                else if (activeStatus === 'pending' && !t.isCompleted) statusMatch = true;
                
                return categoryMatch && statusMatch;
            });

            if (filteredTasks.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-20 text-gray-400">
                    <p>Tidak ada tugas dengan filter ini.</p>
                </div>`;
                return;
            }

            filteredTasks.forEach(t => {
                const deadlineDate = new Date(t.deadline);
                const diffDays = Math.ceil((deadlineDate - new Date()) / (1000 * 60 * 60 * 24)); 
                let badgeClass = 'bg-blue-50 text-blue-700 border border-blue-100 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800';
                let badgeText = `${diffDays} Hari Lagi`;
                if (t.isCompleted) {
                    badgeClass = 'bg-green-50 text-green-700 border border-green-100 dark:bg-green-900/30 dark:text-green-300 dark:border-green-800';
                    badgeText = 'Selesai';
                } else if(diffDays < 0) {
                    badgeClass = 'bg-gray-100 text-gray-600 border border-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-700';
                    badgeText = 'Terlewat';
                } else if(diffDays === 0) {
                    badgeClass = 'bg-red-50 text-red-700 border border-red-100 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800';
                    badgeText = 'Hari Ini!';
                } else if(diffDays <= 3) {
                    badgeClass = 'bg-yellow-50 text-yellow-700 border border-yellow-100 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800';
                }
                const tags = [
                    t.kelompok ? {l:'Kelompok', c:'indigo'} : null,
                    t.vclass ? {l:'VClass', c:'purple'} : null,
                    t.Mandiri ? {l:'Mandiri', c:'orange'} : null,
                    t.praktikum ? {l:'Praktikum', c:'pink'} : null,
                    t.ilab ? {l:'iLab', c:'teal'} : null,
                ].filter(Boolean).map(tag => `<span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-${tag.c}-50 text-${tag.c}-700 border border-${tag.c}-100 dark:bg-${tag.c}-900/30 dark:text-${tag.c}-300 dark:border-${tag.c}-800">${tag.l}</span>`).join('');
                const statusClass = t.isCompleted ? 'border-l-4 border-green-500 opacity-90' : 'border-l-4 border-gray-300 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-500';
                const textColor = t.isCompleted ? 'text-gray-400 line-through dark:text-gray-500' : 'text-gray-800 dark:text-gray-100';
                const imgBtn = t.UrlGambar ? `<button onclick="openModal('image', '${t.UrlGambar}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 flex items-center gap-1.5 text-xs font-semibold bg-blue-50 dark:bg-blue-900/20 px-2.5 py-1.5 rounded-lg transition border border-blue-100 dark:border-blue-800/50"><i class="ph ph-image text-lg"></i> Gambar</button>` : '';
                const hasNote = t.Noted && t.Noted.trim() !== '-' && t.Noted.trim() !== '';
                const safeNote = t.Noted ? t.Noted.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
                const noteBtn = hasNote ? `<button onclick="openModal('text', '${safeNote}')" class="text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 flex items-center gap-1.5 text-xs font-semibold bg-purple-50 dark:bg-purple-900/20 px-2.5 py-1.5 rounded-lg transition border border-purple-100 dark:border-purple-800/50"><i class="ph ph-info text-lg"></i> Info</button>` : '';
                const actionButtons = `<div class="flex gap-2">${imgBtn}${noteBtn}</div>`;
                let html = '';
                if (currentLayout === 'list') {
                    html = `<div class="task-card ${statusClass} relative p-4 rounded-xl bg-white dark:bg-dark-card border border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row gap-4 items-start sm:items-center"><div class="flex-shrink-0 pt-1 sm:pt-0"><input type="checkbox" class="custom-checkbox text-green-500 border-gray-300 dark:border-gray-500" onchange="toggleTask(${t.id}, this.checked)" ${t.isCompleted ? 'checked' : ''}></div><div class="flex-grow w-full"><div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-1"><h3 class="font-bold text-lg ${textColor}">${t.matakuliah}</h3><div class="flex gap-2 items-center self-start sm:self-auto">${actionButtons} <span class="px-2.5 py-0.5 rounded text-xs font-medium ${badgeClass}">${badgeText}</span></div></div><div class="flex flex-wrap gap-2 items-center mb-2"><span class="text-sm font-semibold text-gray-700 dark:text-gray-300">${t.Namatugas}</span><span class="text-xs text-gray-400">| ${deadlineDate.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' })}</span></div><div class="flex gap-2 mb-3">${tags}</div><input type="text" value="${t.catatan || ''}" placeholder="Tulis catatan..." class="w-full bg-transparent border-b border-gray-200 dark:border-gray-700 text-sm py-1 text-gray-600 dark:text-gray-300 focus:outline-none focus:border-blue-500 transition-colors" onblur="saveNote(${t.id}, this.value)"></div></div>`;
                } else {
                    html = `<div class="task-card ${statusClass} flex flex-col justify-between h-full p-5 rounded-xl bg-white dark:bg-dark-card border border-gray-200 dark:border-gray-700"><div class="flex justify-between items-start mb-3"><input type="checkbox" class="custom-checkbox text-green-500 border-gray-300 dark:border-gray-500" onchange="toggleTask(${t.id}, this.checked)" ${t.isCompleted ? 'checked' : ''}><span class="px-2.5 py-0.5 rounded text-xs font-medium ${badgeClass}">${badgeText}</span></div><div class="mb-4"><div class="flex justify-between items-start mb-1"><h3 class="font-bold text-lg leading-tight ${textColor}">${t.matakuliah}</h3>${actionButtons}</div><p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">${t.Namatugas}</p><p class="text-xs text-gray-500 dark:text-gray-400 mb-3 flex items-center gap-1"><i class="ph ph-calendar"></i> ${deadlineDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}</p><div class="flex flex-wrap gap-2">${tags}</div></div><div class="mt-auto pt-3 border-t border-gray-100 dark:border-gray-700 flex items-center gap-2 text-gray-400"><i class="ph ph-pencil-simple text-sm"></i><input type="text" value="${t.catatan || ''}" placeholder="Catatan..." class="w-full bg-transparent text-xs focus:outline-none text-gray-600 dark:text-gray-300" onblur="saveNote(${t.id}, this.value)"></div></div>`;
                }
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function updateStats() {
            const tasks = globalTasks;
            const total = tasks.length;
            const done = tasks.filter(t => t.isCompleted).length;
            document.getElementById('totalCount').innerText = total;
            document.getElementById('doneCount').innerText = done;
            document.getElementById('pendingCount').innerText = total - done;
            const percent = total === 0 ? 0 : Math.round((done / total) * 100);
            const bar = document.getElementById('progressBar');
            bar.style.width = `${percent}%`;
            if(percent === 100) { bar.className = "bg-green-500 h-full rounded-full transition-all duration-700"; } 
            else { bar.className = "bg-blue-600 dark:bg-blue-500 h-full rounded-full transition-all duration-700"; }
            document.getElementById('progressPercent').innerText = `${percent}%`;
            const textEl = document.getElementById('progressText');
            if (total === 0) textEl.innerText = "Tidak ada tugas aktif.";
            else if (percent === 0) textEl.innerText = "Ayo mulai cicil tugasmu!";
            else if (percent < 50) textEl.innerText = "Terus semangat, perjalanan masih panjang.";
            else if (percent < 100) textEl.innerText = "Sedikit lagi selesai!";
            else textEl.innerText = "Kerja bagus! Semua tugas selesai.";
        }
        async function openClassModal() {
            const modal = document.getElementById('classModal');
            const tbody = document.getElementById('classProgressBody');
             const thead = document.querySelector('#classModal thead tr');
            if (thead.children.length === 3) { 
                const th = document.createElement('th');
                th.className = "px-4 py-3 text-center rounded-tr-lg";
                th.innerText = "Detail";
                thead.appendChild(th);
            }
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.firstElementChild.classList.remove('scale-95');
                modal.firstElementChild.classList.add('scale-100');
                modal.classList.remove('opacity-0');
            }, 10);

            try {
                const res = await fetch('/api/student/class-progress');
                const data = await res.json();
                tbody.innerHTML = '';
                
                data.forEach(u => {
                    let color = 'bg-red-500';
                    if(u.percent >= 50 && u.percent < 100) color = 'bg-yellow-500';
                    if(u.percent === 100) color = 'bg-green-500';
                    let statusBadge = '<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs font-semibold">Proses</span>';
                    if(u.percent === 100) statusBadge = '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-semibold">Selesai</span>';

                    const row = `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors border-b dark:border-gray-700">
                            <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                                ${u.displayName}
                                ${u.displayName !== u.npm ? `<br><span class="text-xs text-gray-400 font-mono">${u.npm}</span>` : ''} 
                            </td>
                            <td class="px-6 py-4 w-1/2">
                                <div class="flex justify-between mb-1 text-xs font-medium text-gray-500 dark:text-gray-400">
                                    <span>${u.completed} / ${u.total}</span>
                                    <span>${u.percent}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 overflow-hidden">
                                    <div class="${color} h-2.5 rounded-full transition-all duration-500" style="width: ${u.percent}%"></div>
                                </div>
                            </td>
                           <td class="px-6 py-4 text-right">
                                ${statusBadge}
                            </td>
                            <td class="px-4 py-4 text-center">
                                <button onclick="viewStudentDetail('${u.npm}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition">
                                    <i class="ph ph-eye text-xl"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
             } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat data.</td></tr>';
            }
        }

        async function viewStudentDetail(npm) {
            try {
                Swal.fire({ title: 'Memuat...', didOpen: () => Swal.showLoading() });
                const res = await fetch(`/api/student/class-progress/${npm}`);
                const data = await res.json();
                
                let listHtml = '<div class="text-left space-y-4 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar">';
                if(data.tasks.length === 0) {
                    listHtml += '<p class="text-center text-gray-500">Belum ada tugas.</p>';
                } else {
                    data.tasks.forEach(t => {
                        let statusIcon, statusText, statusClass;
                        if (t.isCompleted) {
                            statusIcon = '<i class="ph ph-check-square text-lg"></i>';
                            statusText = 'Selesai';
                            statusClass = 'text-green-600 font-semibold';
                        } else {
                            statusIcon = '<i class="ph ph-hourglass text-lg"></i>';
                            statusText = 'Proses';
                            statusClass = 'text-gray-600 font-medium';
                        }
                        listHtml += `
                            <div class="border-b border-gray-200 dark:border-gray-700 pb-3 last:border-0">
                                <h4 class="font-bold text-gray-800 dark:text-gray-200 text-sm leading-snug">
                                    ${t.matakuliah} - ${t.namatugas}
                                </h4>                                
                                <div class="flex items-center gap-2 mt-1 text-sm">
                                    <span class="text-gray-500 dark:text-gray-400">Status:</span>
                                    <span class="flex items-center gap-1 ${statusClass}">
                                        ${statusIcon} ${statusText}
                                    </span>                                
                                </div>
                            </div>
                        `;
                    });
                }
                listHtml += '</div>';

                Swal.fire({
                    title: `Detail ${data.npm}`,
                    html: listHtml,
                    width: '500px',
                    showCloseButton: false,
                    showConfirmButton: true,
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1',
                    customClass: {
                        title: 'text-xl font-bold text-gray-800 dark:text-white mb-4',
                        popup: 'rounded-xl dark:bg-gray-800 border dark:border-gray-700'
                    }
                });
            } catch (e) {
                console.error(e);
                Swal.fire('Error', 'Gagal ambil detail', 'error');
            }        
        }

        function closeClassModal() {
            const modal = document.getElementById('classModal');
            modal.classList.add('opacity-0');
            modal.firstElementChild.classList.remove('scale-100');
            modal.firstElementChild.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function openModal(type, content) {
            const modal = document.getElementById('universalModal');
            const titleEl = document.getElementById('modalTitle');
            const imgEl = document.getElementById('modalImage');
            const textEl = document.getElementById('modalText');
            imgEl.classList.add('hidden');
            textEl.classList.add('hidden');
            if (type === 'image') {
                titleEl.innerHTML = '<i class="ph ph-image text-blue-500"></i> Lihat Lampiran';
                imgEl.src = content;
                imgEl.classList.remove('hidden');
            } else {
                titleEl.innerHTML = '<i class="ph ph-note text-purple-500"></i> Catatan Tambahan';
                textEl.innerText = content; 
                textEl.classList.remove('hidden');
            }
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.firstElementChild.classList.remove('scale-95');
                modal.firstElementChild.classList.add('scale-100');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('universalModal');
            modal.classList.add('opacity-0');
            modal.firstElementChild.classList.remove('scale-100');
            modal.firstElementChild.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('modalImage').src = "";
            }, 300);
        }

        async function toggleTask(id, status) {
            try {
                const task = globalTasks.find(t => t.id === id);
                if(task) task.isCompleted = status;
                renderTasks(); 
                updateStats(); 
                await fetch('/api/student/toggle-task', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tugasId: id, isCompleted: status })
                });
            } catch (e) { console.error(e); }
        }

        async function saveNote(id, note) {
            try {
                const task = globalTasks.find(t => t.id === id);
                if(task) task.catatan = note;
                await fetch('/api/student/save-note', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tugasId: id, note: note })
                });
            } catch (e) { console.error(e); }
        }

        async function logout() {
            await fetch('/logout', { method: 'POST' });
            window.location.href = '/';
        }

        initTheme();
        updateLayoutUI();
        loadDashboard();

    </script>
</body>
</html>